{{ template "layout.header.html" . }}
<h1 class="title">Share a file</h1>

<form action="/file/shared" method="post" enctype="multipart/form-data" id="form">

	<input required type="hidden" name="TokenAvoidRefresh" value="{{ .TokenAvoidRefresh }}" />


	<label id="dropzone" for="myFile" class="container-file">
		<div>
			<label id="uploadLabel" for="myFile" class="text">Drop here</label>
			<input required type="file" name="myFile" id="myFile" class="text" />
		</div>
	</label>

	<div id="progresscontainer" class="container-progress">
		<div id="progressbar" class="progress text"></div>
	</div>


	{{ template "layout.form.share.html" . }}
</form>



<script>
	// This trick permit to center the name of the file in the drop area
	// Edit the label with the file name
	var myFile = document.getElementById('myFile');
	var uploadLabel = document.getElementById('uploadLabel');
	myFile.onchange = function (event) {
		uploadLabel.innerHTML = event.target.files[0].name;
		console.log(event)
	}


	// Allow drag & drop
	var dropContainer = document.getElementById("dropzone");
	dropContainer.addEventListener("dragover", (event) => {
		// Avoid the file to be opened on a new tab instead of beeing dropped to the input
		event.preventDefault()
	}, false);
	dropContainer.addEventListener("drop", (event) => {
		// Avoid the file to be opened on a new tab instead of beeing dropped to the input
		event.preventDefault()
		// Get the file from event to apply it on the input
		myFile.files = event.dataTransfer.files;
		// Edit the text of the label
		uploadLabel.innerHTML = event.dataTransfer.files[0].name
	});




	var submit = document.getElementById('submit');
	submit.onclick = function () {
		uploadFile();
	};

	function uploadFile() {

		var file = element("myFile").files[0];

		var formdata = new FormData();
		formdata.append("myFile", file);

		var xhr = new XMLHttpRequest();
		xhr.upload.addEventListener("progress", progressHandler, false);
		xhr.addEventListener("load", completeHandler, false);
		xhr.addEventListener("error", errorHandler, false);
		xhr.addEventListener("abort", abortHandler, false);
		xhr.open("POST", "/file/shared", true);
		xhr.send(formdata);


		// // Prevent closing tab while uploading
		// window.onbeforeunload = function () {
		// 	if (xhr.readyState == 0) {
		// 		return "Cancel upload?";
		// 	}
		// }
	}


	function progressHandler(event) {
		var percent = (event.loaded / event.total) * 100;
		element("progressbar").innerHTML = Math.round(percent) + "%";


		window.onbeforeunload = confirmExit;
		function confirmExit() {
			return "Upload in progress. Confirm leave?";
		}

		displayProgress(percent)
	}


	function completeHandler(event) {
		element("status").innerHTML = event.target.responseText;
		element("progressbar").innerHTML = 0;
	}


	function errorHandler(event) {
		element("progressbar").innerHTML = "Failed";
	}


	function abortHandler(event) {
		element("progressbar").innerHTML = "Aborted";
	}


	function displayProgress(width) {
		// var progresscontainer = document.getElementById("progresscontainer");
		// progresscontainer.classList.replace("hidden", "visible");

		var progressbar = document.getElementById("progressbar");
		progressbar.style.width = width + "%";
	}



</script>


{{ template "layout.footer.html" . }}