{{ template "layout.header.html" . }}



<div id="future">
    <br>
    <br>
    {{ .Id }}
    <br>
    {{ .Password }}
    <br>
    <br>
    <br>
    <br>



    <form id="form">
        <label for="givenPassword">Password</label>
        <input id="givenPassword" type="text" />

        <!-- just to submit with the form -->
        <input id="givenPasswordHash" type="text" disabled />

        <input type="submit" value="unlock">

        <div id="error"></div>

    </form>



    <script>

        let givenPassword                                                               // Password given by the user
        let givenPasswordHash                                                           // Hash of the password given by the user to send to Go
        let form = document.getElementById('form')




        let fragment = decodeURIComponent(window.location.hash.substring(1))        // decodeURIComponent is used because the text is coming from an URL, some char might needs to be decoded (like '=' is '%3d' for example)

        // Read the #fragment again to know if the form must be automatically submitted
        if (fragment) {


            // let fragment = decodeURIComponent(url.substring(url.indexOf('#')+1))        // decodeURIComponent is used because the text is coming from an URL, some char might needs to be decoded (like '=' is '%3d' for example)


            // window.onload = function () {
            document.addEventListener("DOMContentLoaded", function (event) {


                if (fragment) {
                    // givenPassword = location.href.substr(location.href.indexOf("#"))
                    // givenPassword = decodeURIComponent(givenPassword.substring(1)); 
                    
                    
                    givenPassword = fragment
                    // Automatically set the checksum of the password in the hidden input 'givenPasswordHash' to be able to send it through the form
                    document.getElementById("givenPassword").value = givenPassword;
                    document.getElementById("givenPasswordHash").value = sha256(givenPassword);

                    console.log(fragment)
                }

                form.submit();
                console.log("test")
            });
        }


        // Automatically set the checksum of the password in the hidden input 'givenPasswordHash' to be able to send it through the form
        document.getElementById("givenPassword").addEventListener("input", function () {
            document.getElementById("givenPasswordHash").value = sha256(this.value);
        });





        // function submit() {

            // This permit to send data to /share/unlock without reloading the HTML.
            // The URL is configured in Go side to return the password
            form.onsubmit = async (e) => {

                e.preventDefault();

                let future = document.getElementById('future')                                  // Element that will be replaced with the content of the share
                let error = document.getElementById('error')                                    // Element to display error like wrong passwords
                // let givenPassword                                                               // Password given by the user
                // let givenPasswordHash                                                           // Hash of the password given by the user to send to Go

                // givenPassword = document.getElementById('givenPassword').value
                // givenPasswordHash = document.getElementById('givenPasswordHash').value




                // Read the #fragment that contains the password if exists, or use the values filled in the form by the user
                if (!fragment) {

                //     if (fragment) {
                //         givenPassword = location.href.substr(location.href.indexOf("#"))
                //         givenPassword = decodeURIComponent(givenPassword.substring(1));         // decodeURIComponent is used because the text is coming from an URL, some char might needs to be decoded (like '=' is '%3d' for example)

                //         // Automatically set the checksum of the password in the hidden input 'givenPasswordHash' to be able to send it through the form
                //         document.getElementById("givenPassword").value = givenPassword;
                //         document.getElementById("givenPasswordHash").value = sha256(givenPassword);

                //         console.log(givenPassword)
                //     }

                // } else {
                    givenPassword = document.getElementById('givenPassword').value
                    givenPasswordHash = document.getElementById('givenPasswordHash').value
                }




                // Payload to send to backend
                var details = {
                    'givenPasswordHash': givenPasswordHash
                };

                var formBody = [];
                for (var property in details) {
                    var encodedKey = encodeURIComponent(property);
                    var encodedValue = encodeURIComponent(details[property]);
                    formBody.push(encodedKey + "=" + encodedValue);
                }
                formBody = formBody.join("&");



                // Form to discuss with backend
                let response = await fetch('/share/unlock', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded;charset=UTF-8'
                    },
                    // body: new FormData(form)
                    body: formBody
                });

                try {
                    let result = await response.json();


                    // If the given password correspond to the password of the share
                    if (givenPasswordHash === result.sharePasswordHash) {
                        let data = document.createElement('div')
                        data.innerHTML = result.sharePassword;
                        future.replaceWith(data)
                    }
                } catch (e) {
                    // console.log(e);

                    if (!givenPassword) {
                        display_error('Please fill the password')
                    } else {
                        display_error('Wrong password')
                    }
                }
            };
        // }

        // Function to write something on the div "error"
        function display_error(message) {
            let data = document.createElement('div')
            data.setAttribute("id", "error");               // Set the ID to always replace the same element with the error

            data.innerHTML = message;
            error.replaceWith(data);
        }


    </script>

</div>



{{ template "layout.footer.html" . }}